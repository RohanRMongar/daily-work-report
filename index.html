<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Work Report</title>
  <style>
    :root{ --bg:#0b1020; --card:#121a2b; --ink:#e8eefc; --muted:#a9b4cf; --accent:#5aa9ff; --accent-2:#78f0c0; --ring:#2c3b59; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35); }
    @media (prefers-color-scheme: light){ :root{ --bg:#f6f8ff; --card:#fff; --ink:#0b1020; --muted:#4b587a; --ring:#dfe6fb; } }
    *{box-sizing:border-box}
    body{ margin:0; font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:var(--ink); background: radial-gradient(1200px 800px at 20% -10%, #1a2540 0%, transparent 50%) , var(--bg);
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .wrap{ width:100%; max-width:880px; }
    .title{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 14px; }
    h1{ font-size:clamp(20px, 2.8vw, 34px); line-height:1.15; margin:0; letter-spacing:.2px; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)) , var(--card); border:1px solid var(--ring);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:clamp(16px, 2vw, 28px); }
    form{ display:grid; gap:18px; }
    .grid{ display:grid; gap:14px; grid-template-columns:1fr; }
    @media (min-width:680px){ .grid-2{ grid-template-columns:1fr 1fr; } }
    label{ display:grid; gap:8px; font-size:14px; color:var(--muted); }
    .field, select, textarea{ width:100%; background:#0d1526; color:var(--ink); border:1px solid var(--ring); border-radius:12px; padding:12px 14px; font-size:16px; outline:none; }
    .field:focus, select:focus, textarea:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(90,169,255,.15); background:#0f1930; }
    select{ appearance:none; background-image:linear-gradient(45deg, transparent 50%, var(--muted) 50%), linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 20px) calc(1em + 4px), calc(100% - 15px) calc(1em + 4px); background-size:5px 5px, 5px 5px; background-repeat:no-repeat; }
    textarea{ min-height:110px; resize:vertical; }
    .section{ border-top:1px dashed var(--ring); padding-top:14px; }
    .section h2{ font-size:16px; margin:0 0 8px; letter-spacing:.2px; color:var(--ink); display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .rows{ display:grid; gap:12px; }
    .row{ display:grid; gap:10px; grid-template-columns:1fr; padding:12px; border:1px dashed var(--ring); border-radius:12px; background:#0d1526; }
    @media (min-width:680px){ .row{ grid-template-columns: 1fr 1fr auto; align-items:start; } }
    .row .controls{ display:flex; gap:8px; }
    .small-btn{ border:1px solid var(--ring); background:transparent; color:var(--ink); padding:8px 10px; border-radius:10px; cursor:pointer; }
    .add-btn{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1020; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end; margin-top:6px; }
    button{ font-weight:600; letter-spacing:.2px; }
    .btn-primary{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1020; border:none; padding:12px 16px; border-radius:12px; cursor:pointer; }
    .btn-outline{ background:transparent; color:var(--ink); border:1px solid var(--ring); padding:12px 16px; border-radius:12px; cursor:pointer; }
    .note{ font-size:13px; color:var(--muted); }
    .alert{ padding:12px; border-radius:12px; border:1px solid var(--ring); }
    .alert.ok{ border-color:rgba(64,192,87,.4); background:rgba(64,192,87,.08); }
    .alert.err{ border-color:rgba(255,107,107,.4); background:rgba(255,107,107,.08); }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="title">
      <h1>Daily Work Report</h1>
      <div class="note" id="todayNote"></div>
    </div>
    <div class="card">
      <form id="reportForm" novalidate>
        <!-- Name + Date -->
        <div class="grid grid-2">
          <label> Name
            <select name="name" id="nameSelect" required>
              <option value="">Select your name…</option>
            </select>
          </label>
          <label> Date
            <input class="field" name="date" type="date" required />
          </label>
        </div>

        <!-- Morning -->
        <div class="section">
          <h2>
            Morning
            <button type="button" class="add-btn" id="addMorning">+ Add activity</button>
          </h2>
          <div class="rows" id="morningRows"></div>
        </div>

        <!-- Afternoon -->
        <div class="section">
          <h2>
            Afternoon
            <button type="button" class="add-btn" id="addAfternoon">+ Add activity</button>
          </h2>
          <div class="rows" id="afternoonRows"></div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="reset" class="btn-outline">Clear</button>
          <button type="submit" class="btn-primary">Submit</button>
        </div>

        <div id="msg" class="note" style="margin-top:8px;"></div>
      </form>
    </div>
  </main>

  <script>
    // ===== CONFIG =====
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzTv4ye6jVsXjyRcbB4ZMa3SuqgxpXW-PJ9E7HXKdLqqJwzSmwurL-3UMcW5OUsQAG8/exec';  // e.g., https://script.google.com/macros/s/AKfy.../exec
    const TOKEN = 'AIS2025WORKREPORT';

    // helper text + default date
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById('todayNote').textContent = `Local time zone: ${tz}`;
    document.querySelector('input[name="date"]').valueAsDate = new Date();

    // ===== JSONP loader =====
    function jsonp(url){
      return new Promise(resolve => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => { resolve(data); delete window[cb]; script.remove(); };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
        document.body.appendChild(script);
      });
    }
    function fillSelect(selectEl, items){
      for (let i = selectEl.options.length - 1; i >= 1; i--) selectEl.remove(i);
      items = Array.from(new Set(items)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
      for (const v of items){
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        selectEl.appendChild(opt);
      }
    }

    let activitiesCache = [];
    async function loadDropdowns(){
      try {
        const [names, activities] = await Promise.all([
          jsonp(`${ENDPOINT}?q=names`),
          jsonp(`${ENDPOINT}?q=activities`)
        ]);
        fillSelect(document.getElementById('nameSelect'), names || []);
        activitiesCache = activities || [];
        // create an initial row for morning and afternoon
        addRow('morningRows');
        addRow('afternoonRows');
      } catch (e){ console.warn('Failed to load dropdowns', e); }
    }

    // ===== Dynamic Rows =====
    function createActivityRow(sectionKey){
      const row = document.createElement('div');
      row.className = 'row';

      // activity select
      const activityLabel = document.createElement('label');
      activityLabel.textContent = 'Activity';
      const activitySelect = document.createElement('select');
      activitySelect.name = sectionKey + '_activity[]';
      activitySelect.required = true;
      const placeholder = document.createElement('option');
      placeholder.value = ''; placeholder.textContent = 'Select activity…';
      activitySelect.appendChild(placeholder);
      // populate with cached activities
      for (const v of Array.from(new Set(activitiesCache)).filter(Boolean).sort((a,b)=>a.localeCompare(b))){
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        activitySelect.appendChild(opt);
      }
      activityLabel.appendChild(activitySelect);

      // details textarea
      const textLabel = document.createElement('label');
      textLabel.textContent = 'Details (what was done)';
      const textArea = document.createElement('textarea');
      textArea.name = sectionKey + '_text[]';
      textArea.placeholder = `Describe your ${sectionKey} work…`;
      textArea.required = true;
      textLabel.appendChild(textArea);

      // remove button
      const controls = document.createElement('div');
      controls.className = 'controls';
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'small-btn';
      removeBtn.textContent = '✕ Remove';
      removeBtn.addEventListener('click', () => {
        const container = row.parentElement;
        // keep at least one row
        if (container.querySelectorAll('.row').length > 1) {
          row.remove();
        } else {
          // if last row, just clear it
          activitySelect.value = '';
          textArea.value = '';
        }
      });
      controls.appendChild(removeBtn);

      // layout: [select] [textarea] [controls]
      row.appendChild(activityLabel);
      row.appendChild(textLabel);
      row.appendChild(controls);

      return row;
    }

    function addRow(containerId){
      const container = document.getElementById(containerId);
      const sectionKey = containerId.startsWith('morning') ? 'morning' : 'afternoon';
      container.appendChild(createActivityRow(sectionKey));
    }

    document.getElementById('addMorning').addEventListener('click', () => addRow('morningRows'));
    document.getElementById('addAfternoon').addEventListener('click', () => addRow('afternoonRows'));

    loadDropdowns();

    // ===== SUBMIT (Option 1: no-cors) =====
    const form = document.getElementById('reportForm');
    const msg = document.getElementById('msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!form.reportValidity()) {
        msg.className = 'alert err';
        msg.textContent = 'Please fill all required fields.';
        return;
      }
      msg.className = 'note';
      msg.textContent = 'Submitting…';

      const data = new FormData(form);
      data.append('token', TOKEN);
      const body = new URLSearchParams(data);

      try {
        await fetch(ENDPOINT, { method: 'POST', mode: 'no-cors', body });
        msg.className = 'alert ok';
        msg.textContent = 'Submitted! Thank you.';
        form.reset();
        document.querySelector('input[name="date"]').valueAsDate = new Date();
        // re-create first rows so form isn't empty after reset
        document.getElementById('morningRows').innerHTML = '';
        document.getElementById('afternoonRows').innerHTML = '';
        addRow('morningRows'); addRow('afternoonRows');
      } catch (err) {
        msg.className = 'alert err';
        msg.textContent = 'Network error. Please try again.';
      }
    });
  </script>
</body>
</html>
